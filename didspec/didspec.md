# DKPI DID 结构声明

## 简介

在我们构建的去中心化数字身份管理系统中，每个主体都拥有一个主体身份，以身份ID区分。每个数字身份在当前整个管理系统中应当是唯一的，在整个互联网环境中都应当是安全的。创建数字身份的意义在于使用这个身份与其他主体进行交互、或是使用某个供应方提供的服务。鉴于此，每个主体身份需要指向一个身份文档，用于提供交互过程中所需要的信息。

本文指定了一个身份文档的格式规范，并介绍在实际应用过程中如何利用该文档来完成安全的交互流程。

DID文档的生成和存储依赖于区块链、智能合约、IPFS等，智能合约所提供的共识协议能保障每套文档的增删查改操作只能由文档拥有者执行，IPFS作为DID文档原件的存储媒介，特点是以文件哈希作为文件读取路径的基础，由此可以保证原始文档不被篡改。区块链作为DID身份的存储媒介，并提供DID身份到DID文档的索引。

DID文档的功能主要有两个方面，一是安全展示身份主体的身份信息，如非对称公钥，安全的含义是在展示的同时能保证展示信息不会被第三方篡改；二是存储与其他实体之间约定的公共信息，通过IPFS和区块链来保障这些信息的安全。而敏感信息，如非对称私钥、token、app secret等只能由拥有者保管的信息，不应该存储到DID文档，而是通过存储在DID文档的、对应的可公开信息来提供这些敏感信息的索引。敏感信息的保存由拥有者自己管理，推荐的解决方案包括使用特制的加密保存模块、数据库加密存储等。

## DID JSON文档字段简介

| 字段             | 类型         | 简介                                                     |
| ---------------- | ------------ | -------------------------------------------------------- |
| `@contexts`      | String/Array | 所遵循的W3C标准                                          |
| `id`             | String       | 规定文档拥有者的身份                                     |
| `pubkey`         | Array        | 公钥，含多组，每组公钥限定使用范围或对应服务`scope`      |
| `authentication` | Array        | 其他主体可以使用该字段中提供的公钥来对本主体进行身份校检 |
| `authorization`  | Array        | 规定本主体对其他主体的代理授权                           |
| `service`        | Array        | 规定本主体允许接入的服务                                 |

## 字段详情

### `@contexts`

String

规定本文档遵循的W3C标准，可包含一条或多条URI。本文指定的文档规范遵循w3c did草案第一版，故第一条URI必须是`https://www.w3.org/2019/did/v1`。

### `id`

String

文档拥有主体的身份id，id的格式为：

````
legal-char      = [a-z0-9]
legal-all-char  = [a-zA-Z0-9]
id-main         = "did:" company-abbr ":" id-type ":" identifier
id              = id-main [';' service] ['@' id-main] ['#' fragment] 
company-abbr    = legal-char{3, 4}
id-type         = legal-char{3, 4}
identifier      = legal-all-char{24,}
fragment        = legal-all-char{1, 12}
service         = legal-all-char{1, 12}
````

主体id作为主体身份的标识，在整个身份管理系统范围内是唯一的，这将由联盟链的智能合约来保证，主体在注册身份的时候提供自己的所在企业(对应id中的company-abbr字段)和id类型(对应id-type字段)，由智能合约根据时间戳、该企业指定的命名规范等规则来生成id标识(对应identifier字段)，由此生成一个唯一的id。

### `pubkey`

Array

声明该主体拥有的公钥，可包含多组公钥，每组公钥内容(Object)包括

* id：公钥ID，每组公钥ID唯一
* type：指密钥对生成时使用的加密算法
* content：声明公钥内容

每个主体应提供多组使用不同加密算法生成的公钥，以供未来与其他主体交互时、根据双方计算能力条件来协商使用哪组公钥；另外，这里也可以存储会在多个授权或服务中要用到的公钥，避免重复声明。

### `authentication`

Array

声明该主体提供的身份验证公钥，让其他主体可以自行选择支持的验证算法和公钥来对本主体进行身份校检。可指定一个公钥ID(String)，说明使用本主体对应ID的公钥，或单独声明一个ID(Object)，同样包含id、type和content字段。

### `authorization`

Array

声明该主体的授权主体，包含多组，每组授权内容包括

* id：授权记录id，用于索引对应的私钥，记录id`@`标识符后跟的身份id就是该授权记录被授权者的身份id
* scope：授权范围，包含多条，每条的格式可参考`[service]:[operation]`
* expiredAt：授权截止期限，
* pubkey：该授权主体进行交互时使用的公钥，可指定一个公钥ID(String)，或单独声明一个ID(Object)，包含type和content字段。

在授权范围以内，被授权主体可以代替本主体执行相应操作。每个被授权主体可以有多条授权记录，根据授权类型和截止期限的不同来分成不同记录存储。

### `service`

Array

声明该主体允许接入的服务，与授权的不同之处在于，接入的服务供应方不是联盟链中的成员，即没有对应的主体身份及主体ID，一般通过http协议来提供服务。包含多组，每组内容包括：

* id：服务id，在该主体的所有服务范围内唯一，
* scope：权限范围
* endpoint：允许供应方接入的url，
* expiredAt：服务截止期限
* 其他字段可根据服务所需再额外声明

## 身份文档操作

### 注册

### 读取

### 更新

### 注销

## 交互流程

### 数字主体身份与物理实体的绑定

每个数字主体身份都只能由一台物理实体拥有。主体身份的拥有权依赖于非对称私钥和区块链账号密钥两者的拥有权。在注册完DID身份后，每台物理实体根据自身设备条件保管自己的私钥和区块链密钥，不得转让。

### 授权相关

授权是指主体把自身某部分信息的操作权限托付给其他主体。授权相关的操作至少涉及到三个角色：授权主体、被授权主体、服务方。被授权主体必须也是联盟链中的成员，服务方则没有要求，亦可是传统中心化服务商。

#### 授权申请和撤销

#### 授权内容交互

以一台私家车内置的停车支付模块为例，主体身份是指私家车的主体身份，对应的物理实体是私家车主控制器；支付模块已经获得了私家车主体的授权，授权范围包括车辆定位`(all:location)`、数字钱包支付`(all:payment)`，此外授权内容加入了额外字段，例如限制单笔支付金额上限`({"paymentLimit": 50.00})`。

1. 必须经由主体获取的数据

对于必须经由主体获取的数据，比如车辆定位信息，其他设备要获取定位信息只能从私家车主控制器获取，被授权设备要读取这类数据，都需要向授权主体发起请求，请求中携带自身数字身份ID和本轮交互使用的公钥，授权主体在收到请求之后，先与请求方互相验证对方身份，验证为已授权主体之后，再将请求数据交付给请求方。

2. 不必经由主体获取的数据

> 参考OAuth2流程，[阮一峰的博客](https://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html) / [官网](https://oauth.net/2/)

对于不必经由主体获取的数据，如数字钱包支付接口，其他设备可以直接调用服务方提供的接口来完成服务的，在每轮交互之前，被授权设备需要先向授权主体申请一套交互token，授权主体在验证了申请方的身份之后，*分别向服务方和被授权设备发送一套新生成的token，二者自行保存这套token*，或*授权主体使用服务密钥向服务方申请一套新的token，发送给被授权设备*，用于后续交互；每套token都有一定的有效期限，且只赋予一定范围的操作权限，权限的限定是由授权主体在生成token的时候根据身份文档中对该被授权设备的权限控制以及当前正在使用的数据类型来决定的，在向服务方发送的token当中会加入操作权限和被授权设备的身份类型(如该设备是被授权设备而不是授权主体、该设备的操作风险等级等)的声明，服务方可根据这个声明来控制这套token的操作权限，此外服务方本身也会根据授权主体在最初申请服务的时候选择或允许的权限来控制当前token的权限分发。

被授权设备在拿到token之后，在有效期内，每次与服务方的交互都需要携带这套token，服务方会直接拒绝不携带token或token过期、权限不符等无效的交互。服务方在确认当前交互有效之后，就会执行被授权设备发起的操作。

#### 被授权主体

被授权主体一般都会长期或定期执行一套服务程序，来执行被授权的任务。被授权主体可以新建一条服务记录，来建立对应token的索引。

### 服务相关

服务是指主体本体希望从一个第三方服务供应方获取某些服务。服务相关的操作至少涉及到两个角色：服务主体、服务供应方。

#### 服务申请

服务申请包括两种，一是服务主体向供应方申请享用一种对主体有利的服务，二是供应方主动向主体推荐一种服务，需要获得服务主体部分数据的操作权限。

1. 主体申请服务

对该类服务，在DID文档中记录的服务数据只做存档用，对后续的交互过程影响不大，例如服务主体向一新闻提供方申请每日定时推送时下热点新闻的服务，在申请过程中新闻提供方会向服务主体发放一组服务token或密钥，但这组密钥不会存储在DID文档中，服务主体会在DID文档中新添一组服务记录，并为这组密钥添加这组服务记录id的索引，以便后续与新闻提供方交互时，可根据服务记录中预留的url来识别服务记录、并根据该条记录的id来获取对应的密钥。

2. 供应方推荐服务

#### 服务内容交互

<!-- TODO: -->