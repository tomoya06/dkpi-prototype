# DID授权操作

## 需求分析

在现有的DID身份管理体系之下，有些场景为了减轻主ID身份主体的操作负担，或者将某些特定操作交给有专门处理能力的主体，在这些场景下，DID授权操作将大有用途。

授权操作包括权限的分发、交互时权限验证等关键点。

## 实现原理

1. 与OAuth2协议系统的结合

在遵循OAuth2协议的交互系统中，主要有三个角色：服务提供方、用户主体、交互应用，其中交互应用需要获得用户主体的授权，对用户提供方中、该用户主体所拥有的数据进行读写操作。使用密码式OAuth协议的系统，从授权到进行合法交互的过程主要有以下步骤：

* 用户主体给交互应用提供自己的账号和密码，
* 交互应用使用账号密码登录到服务提供方的服务平台，
* 服务提供方验证账号密码信息，无误后返回对应该用户的令牌/token，
* 交互应用获得token，之后每次调用服务提供方的应用接口的时候都要携带这个token，这样每次的调用才是合法的

在这个流程里，交互应用实际上也是由用户主体掌控的，目前还没有涉及到第三方身份主体。

每个token都有对应的时限和操作范围，来限制使用者的读写能力。

根据此流程，可以设计出现有DID体系与该流程的结合，从而为DID体系注入授权能力。

在新的DID体系下，应包含至少以下角色：服务提供方、用户主体（包括用户主体身份与用户主体掌控的交互应用）、被授权主体。DID与OAuth结合之后的授权流程如下：

* 用户主体使用自己的在该服务下的账号和密码登录到服务提供方的服务平台，获得token，
* 用户主体将token安全存储到本地，并将被授权主体的身份信息、授权范围、token序号（注意不是token本体）添加到DID文档，作为存档
* 用户主体向被授权主体发送token（加密传输，可以使用之前已经实现的基于DID公开密钥的加密传输，或者基于HTTPS协议的安全传输）
* 被授权主体获得token，之后每次调用服务提供方的应用接口的时候都要携带这个token，有需要时与用户主体交流调用结果

2. 使用零知识证明实现的DID授权系统

与OAuth2结合的授权系统不用考虑服务提供方如何生成和管理token，这一部分由服务提供方根据OAuth协议来自行管理，一般来说，服务提供方会根据当前时间、用户身份、读写权限等信息来生成一个哈希值，这个哈希值就作为token，在发给调用方的同时自己也会存储一份到自己的数据库。这里另外提供了一个不基于OAuth协议，而是基于零知识证明来完成的授权流程，并提供一个服务提供方管理和生成token的建议方案。

这里也要考虑到三个角色：服务提供方、用户主体、被授权主体。与上一方案不同的是，这里的服务提供方归用户主体所有，而上一方案的服务提供方一般只归用户主体信赖的第三方拥有。因此在这里，用户主体可以对自己的数据有完整的读写权限。

授权流程如下：

* 用户主体定期生成一份新的token，用这个token对称加密自己的数据，将加密后的数据交付给服务提供方，并将token的哈希值也一起交付
* 服务提供方收到新的加密数据之后，将存储的旧数据全部清除，欢成新的加密数据
* 用户主体将当前有效的token发送给被授权主体
* 被授权主体每次向服务提供方调用服务的时候，携带的是token的哈希值，服务提供方检查哈希值是否一致，一致则将需要的数据发回给被授权主体
  * 若所发的数据是用户主体拥有的数据，则发送的是用token加密过的数据
  * 若是服务提供方生成的数据，可以不加密数据，或者使用token的哈希值对称加密
  * 所有数据都属加密传输的，参考之前的括号解释；数据包中应携带一个字段告知对方当前的数据是使用何者加密的
* 被授权主体收到数据之后，根据字段告知，选择token或者token的哈希值来解密数据
* 当用户主体换了新的token执行第一个步骤之后，之前所有的token都将失效
