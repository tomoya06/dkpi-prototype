# DID授权操作

## 需求分析

在现有的DID身份管理体系之下，有些场景为了减轻主ID身份主体的操作负担，或者将某些特定操作交给有专门处理能力的主体，在这些场景下，DID授权操作将大有用途。

授权操作包括权限的分发、交互时权限验证等关键点。

## 实现原理

首先声明的是，以下所有涉及到不同设备之间的信息传输，不管数据本身加密与否，都使用加密传输。加密传输可基于HTTPS协议实现，或者使用上一阶段的基于DID身份密钥对的加密传输实现。

### 1. 与OAuth2协议系统的结合

在遵循OAuth2协议的交互系统中，主要有三个角色：服务提供方、用户主体、交互应用，其中交互应用需要获得用户主体的授权，对用户提供方中、该用户主体所拥有的数据进行读写操作。使用密码式OAuth协议的系统，从授权到进行合法交互的过程主要有以下步骤：

* 用户主体给交互应用提供自己的账号和密码，
* 交互应用使用账号密码登录到服务提供方的服务平台，
* 服务提供方验证账号密码信息，无误后返回对应该用户的令牌/token，
* 交互应用获得token，之后每次调用服务提供方的应用接口的时候都要携带这个token，这样每次的调用才是合法的

在这个流程里，交互应用实际上也是由用户主体掌控的，目前还没有涉及到第三方身份主体。

每个token都有对应的时限和操作范围，来限制使用者的读写能力。

根据此流程，可以设计出现有DID体系与该流程的结合，从而为DID体系注入授权能力。

在新的DID体系下，应包含至少以下角色：服务提供方、用户主体（包括用户主体身份与用户主体掌控的交互应用）、被授权主体。DID与OAuth结合之后的授权流程如下：

* 用户主体使用自己的在该服务下的账号和密码登录到服务提供方的服务平台，获得token，
* 用户主体将token安全存储到本地，并将被授权主体的身份信息、授权范围、token序号（注意不是token本体）添加到DID文档，作为存档
* 用户主体向被授权主体发送token（加密传输，可以使用之前已经实现的基于DID公开密钥的加密传输，或者基于HTTPS协议的安全传输）
* 被授权主体获得token，之后每次调用服务提供方的应用接口的时候都要携带这个token，有需要时与用户主体交流调用结果

实现相关文件：

* [auth.delegation.js](/auth.delegation.js)：被授权主体脚本
* [lib/AUTHapi.js](/lib/AUTHapi.js)：授权相关api库

### 2. 使用零知识证明实现的DID授权系统

与OAuth2结合的授权系统不用考虑服务提供方如何生成和管理token，这一部分由服务提供方根据OAuth协议来自行管理，一般来说，服务提供方会根据当前时间、用户身份、读写权限等信息来生成一个哈希值，这个哈希值就作为token，在发给调用方的同时自己也会存储一份到自己的数据库。这里另外提供了一个不基于OAuth协议，而是基于零知识证明来完成的授权流程，并提供一个服务提供方管理和生成token的建议方案。

这里要考虑到四个角色：服务提供方、用户主体、用户主体数据提供方、被授权主体。用户主体数据提供方也由用户主体拥有，可以部署在同一设备上，也可部署在不用设备，用户主体平常会一直将自己的数据交给数据提供方来管理。数据提供方只对信任的服务提供方提供数据支持，服务提供方也属于一个DID身份主体，所以这一环节可以通过前一阶段实现的身份校检来完成。

授权交互流程如下：

* 用户主体准备授权：生成一份token和token的哈希值，在DID文档中添加被授权主体的身份信息、授权范围、token序号（注意不是token本体）
* 用户主体将token发送给被授权主体，将token和哈希发送给数据提供方，数据提供方将哈希转发给服务提供方
* 被授权主体要调用服务的时候，每次请求都要携带token哈希
* 服务提供方相应每次服务调用，先检查token哈希是否与本地存储的哈希一致，并检查服务范围是否与该token对应的授权范围一致，若不一致直接拒绝，若一致：
  * 如果不需要用户主体提供数据，则将要发送的数据先使用token哈希值作为密钥对称加密，然后发送给被授权主体
  * 如果需要提供数据，则向数据提供方请求数据，携带token哈希，数据提供方同样会检查哈希一致和授权范围一致，然后将数据使用token作为密钥对称加密，发送给服务提供方，后者再将数据转发给被授权主体
  * 服务提供方向授权主体发送数据的时候，应使用一个字段告知后者当前数据是使用何者加密的，这个字段本身不用加密
* 被授权主体根据字段告知来解密数据，完成一次交互
* 若用户主体打算撤销某份授权，在删除了本地的token和token哈希记录之后，需要通知数据提供方和服务提供方删除本地存储的token和token哈希记录，并清除DID文档上的授权记录

实现相关文件：

* [auths.delegation.js](/auths.delegation.js)：被授权主体脚本
* [auths.service.js](/auths.service.js)：服务提供方脚本

