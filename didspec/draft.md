## 引言

### 研究背景

物联网（The Internet of Things, IoT）技术在现实世界的应用非常广泛，并呈现出爆炸式增长的态势，智能设备的自主交互将成为未来智能系统的核心应用技术。据估计，在未来四年内将有逾10亿新的智能设备上线、相互传输超过44ZB（Zettabyte, 1ZB=10^21bytes）的数据[1]。

如此大规模的设备网络也促使人们寻找一种更安全、更快速的方案来完成物联网设备的识别、交互、数据传输等任务[4]。物联网设备的识别依靠的是每台设备独一无二的数字身份，设备间的交互和数据传输都基于每台设备独有的数字身份来完成，所以对一个物联网体系而言，如何管理和维护设备的数字身份，就是衡量这个平台安全性的关键因素。

当今的物联网设备大多依托中心化的系统来完成数字身份的管理，例如笔者将在后面介绍的阿里云物联网平台。中心化物联网系统提供的解决方案是：由系统中心、即某一物联网平台的运营团体，来统一负责物联网设备数字身份的管理，比如身份签发、验证、撤销、存储等，设备的操作指令和事件监听的定义需事先在平台上注册，设备之间的信息交互都由该平台的信息服务器来中转。总体来说，整个体系是高度中心化的，使用该平台的所有设备，几乎每一步的交互操作都会有平台中心的介入，也就是有第三方的介入。

中心化物联网体系的优势有很多，包括： 

* 成熟的物联网平台能提供更安全、更稳定的网络服务；
* 对于常见的物联网应用场景，平台会提供方便的开发工具和模板，减少重复“造轮子”的工作量，提高开发效率。

但与此同时，中心化体系的弊端固然存在，包括：

* 最大的弊端在于，设备之间发送的所有信息实际上都经过了物联网平台服务器的中转，在信息敏感度较高的场景下，如涉及到货币交易、个人信息的场景，用户并非都能安心将自己的信息暴露给第三方；
* 在一些流程较为复杂的场景，开发者更希望能对物联网的数字身份有更深度的控制权限，例如给每个数字身份绑定更丰富的信息，但在中心化的物联网身份管理体系下，数字身份相关的操作都是封装起来的，开发者无法自行控制身份管理相关的操作，每次只能向中心服务器询问、等待服务器的应答，更没有能力对数字身份添加其他信息。
* 随着物联网设备应用规模的急剧增大，中心化系统的承载能力、防灾能力也将受到极大考验。若系统中心遭受攻击导致崩坏，会直接导致整个系统无法运行。

区块链是一种能保证自身数据不可篡改的数据结构。2009年中本聪创建的比特币网络是对区块链的第一次大规模应用。比特币网络是一种去中心化的网络体系，实际上是一个P2P网络。每个参与该网络的设备称为一个节点，节点之间使用”比特币“这一虚拟货币进行交易。每个节点都持有一套“账本”，记录着节点之间的所有交易记录，而这个所谓“账本”就是使用区块链存储的数据记录。区块链特殊的数据结构设计能保证所有节点持有的账本内容均一致，并且可以永久查询其中任意一笔交易信息。比特币网络不存在中心化的管理机构，但同样可以保证整个系统稳定持续运行。

比特币以及一众基于区块链实现的去中心化项目，让物联网开发者开始考虑使用区块链技术来实现去中心化物联网平台的可能性。区块链这一数据结构能有效保证数字身份存储的安全性，通过在区块链网络上部署智能合约，可以让每个节点都有识别身份、操作自身身份内容的能力，而无需中心化服务器的干预。所以从理论上，使用区块链技术来实现一个安全、高效的去中心化数字身份管理体系，是完全可行的。

### 研究现状

目前已经有不少基于区块链技术实现的物联网方案，不过每个方案的侧重点都有所不同。综合分析各篇文献中的实现方案，在设计和实现的过程中，需要关注的问题主要包括以下几个方面：

* 网络协议的选择：物联网常用的网络协议与互联网中常用的协议有所不同，需要根据应用场景、设备性能、并结合后续网络拓扑的设计和节点交互设计，来综合考虑选用何种网络协议；
* 网络拓扑结构的设计：根据设计方案中预期的设备规模、设备类型来确定选用何种网络拓扑结构，或是根据所选的网络协议、设备性能和功能来将不同设备划分层级，以此高效组织网络中的所有设备；
* 节点之间数据交互的逻辑设计：这一点主要与所选用的网络协议相关，例如使用MQTT协议，节点之间的数据交互是基于发布/订阅范式，也就意味着在两个节点之间还要引入一个中介(Broker)，来完成数据转发；或是经典的HTTP协议，节点之间可以直接收发数据；
* 共识机制的选用：选用合适的共识机制可以有效保障当前去中心网络中各项决策的有效性，也有利于提高决策通过的效率；
* 智能合约的设计：作为区块链读写的媒介，并且为区块链中的数据赋予实际含义；
* 智能设备的身份管理：包括数字身份的分配和鉴定，设备在进行信息交互之前都要互相鉴定对方的数字身份，数字身份的分配规则和鉴定流程就成为了整套方案的安全基础。

在立项初期所接触的文献当中，文献[2]基于MQTT协议，介绍了一种新的分布式中间件的实现方案，文中指出，一个系统内可以同时存在多个中间件，每个中间件都可充当区块链的验证节点（Validator），从而提高区块链数据验证的效率，更充分地保障数据的完整性；文献[3]提出，使用区块链和智能合约进行物联网设备的管理，每个小型私有物联网中的智能设备通过一个管理员（Manager）节点与区块链交互，智能设备本身不成为区块链节点，这个管理员节点设备将作为所在局域网内所有智能设备与区块链交互的媒介；文献[5]引入了侧链（Sidechain）的概念，设计了模块化联盟网络（Modular Consortium Network），实质是一个由诸多独立、小规模的区块链组成的更大规模的P2P网络，这样可以减轻物联网设备存储完整区块链数据结构的负担，另外还引入IPFS（Inter-Planetary File System，星际文件系统）来存储物联网设备数据，最后给出了通过智能合约来控制用户数据读取权限的方案。文献最后使用以太坊（Ethereum）[8]和Monax两种区块链平台实现了设计方案并进行性能测试，在高交易量的情况下各节点的资源消耗情况均较为乐观；文献[7]以物联网设备的固件更新作为研究案例，结合区块链网络节点和传统C/S模型，设计了一种新的物联网网络架构。

此外，除了理论模型方面的研究，区块链也有不少实际应用案例：文献[9]介绍了区块链应用于基于云端的制造业（Cloud-Based Manufacturing, CBM）的方案，block32.me使用区块链存储用户医疗信息并通过机器学习分析用户健康状况[10]，文献[11]将区块链技术应用到自动化生产中，等等。

这里罗列了几篇文献中提供的方案，并进行简单分析，这些方案在立项初期为笔者提供了丰富的理论基础，帮助笔者掌握了物联网技术与区块链技术的契合点，也带来一些初步的方案设计灵感，对后续进行项目需求分析和方案架构设计有极大帮助；在第二章将对方案中涉及到的理论基础进行详细介绍，在第三章将着重介绍和分析另外几项方案，后者为本论文的方案设计提供了更为确切的设计思路。

### 研究内容

综上，为了解决传统的中心化物联网体系中存在的问题，我们将探讨如何使用区块链技术来实现一套去中心化的物联网体系，探讨的侧重点包括以下几点：一是智能设备数字身份的管理，二是节点之间使用这套数字身份进行数据交互的逻辑设计，三是网络协议的选择和网络拓扑结构的设计。据此我们将设计一套可行的物联网数字身份管理体系，并且构建一些对应的应用场景，将设计的体系方案加以仿真实现和测试。

前文提到，在中心化的物联网体系中，设备无法对自己的数字身份有过多的操作能力。基于此，在完成初步方案的实现之后，我们还将对方案进行拓展，主要目的在于丰富数字身份的内容和功能，增加设备在数字身份操作权限方面的能力，由此提高设备与设备之间关系的灵活度，增强设备之间相互合作的能力。

### 论文结构

为了呈现方案从设计到实现的全过程，本章引言之后，本文将按照以下结构进行阐述：

第二章首先会介绍方案设计中所涉及到的各项技术和知识点，包括最基本的物联网和区块链的定义、密码学相关的知识等；

第三章将详细介绍现有的几套物联网方案，包括多项去中心化的方案，不仅在理论设计方面非常严谨，从方案实现的角度也能提供重要的参考价值；以及一项中心化方案，阿里云的物联网设备身份认证方案。阿里云是国内权威的物联网平台之一，具有代表意义，另外也会简单介绍国内其他厂商提供的物联网服务平台，不过总体来看与阿里云的方案差别不大，而阿里云所提供的技术文档更为详细到位，所以不重点讨论。

第四章将开始进行方案设计，首先会结合现有方案和实际应用场景进行需求分析，由此提出方案细节；第五章是方案实现的介绍，将重点罗列实现过程中使用到的技术栈，并展示对应功能的程序代码；第六章将介绍方案测试的流程和结果。

第七章开始将会介绍对现有设计方案的拓展，让现有方案满足更丰富的应用场景。类似地，首先会结合不同的应用场景来提出新的需求，从而进行方案升级的分析；之后将对拓展方案加以实现和测试，在第八章中呈现结果。

由于时间和能力有限，本文提出的方案固然存在不少缺陷和不足，因此在最后一章，笔者将会对整个项目进行分析总结，并提出笔者自己对该项目的期望。

## 相关技术

### 物联网

#### 定义

物联网(Internet of Things)这一概念最早诞生于上世纪80、90年代，来自MIT Auto-ID实验室的Ashton教授1999年最早提出来了“Internet of Things”这一术语，[15]它指的是以互联网或其他传统电信网作为信息载体，把诸多行使特定功能的普通物体互联互通的一个网络，来实现智能化识别和管理。物联网为现实世界赋予了数字化的能力，极大拓展了物联网的应用范围。物联网也被称为继计算机、互联网之后世界信息产业发展的第三次浪潮。[13]

#### 常用通信协议

物联网的技术核心依旧是互联网，但针对物联网的应用场景，传统的互联网技术需要经过升级适配，才能满足物联网的实际需求，其中的关键之一是通信协议的升级。

当今在互联网使用的网络通信协议大多基于OSI七层模型结构，[14]七层结构从底层到上层依次为：物理层、数据链路层、网络层、传输层、会话层、表示层、应用层。实际应用时还会将会话层、表示层一同合并到应用层，变成五层模型。每层结构都有特定的功能，对上一层传来的数据进行处理之后，传给下一层，从而逐步把从网线或其他物理媒介送进来的二进制数据解析成普通人能理解的信息，或者反向将信息编译成二进制数据发送给其他机器。

每层结构都定义了多种协议，来满足不同场景的应用需求。在实际开发过程当中，我们关注较多的是五层结构中传输层和应用层的协议。传输层协议主要有TCP、UDP两种，TCP协议面向连接，能确保数据发送之后能被对方接受，不会丢失，经常与网络层的IP协议搭配使用，被合称为TCP/IP协议；而UDP协议不面向连接，无法做出这种保障，优势在于数据传送速度快。应用层协议中，基于TCP/IP协议的有HTTP、FTP、SMTP等，基于UDP的有NFS、DNS、TFTP等。

在物联网的实际场景中，物理设备大多是资源受限的，意思是设备的硬件条件较低，如内存、CPU、网络带宽和网络稳定性等。直接在物联网场景中使用传统互联网的网络协议来实现信息交换是不现实的。因此为了让资源受限设备能顺利完成信息交换，需要制定新的通信协议，主要是应用层协议的更新。

* HTTP

HTTP(HyperText Transfer Protocol，中文翻译为超文本传输协议)是应用最广泛的应用层协议，是互联网数据通信的基础。虽然在物联网领域直接使用HTTP协议进行通信的场景不多，但有不少协议在实际部署的时候，会基于HTTP服务来实现，例如WebSocket；也有很多协议在设计之初也会考虑兼容HTTP，例如CoAP。

HTTP是一个客户端和服务端间请求和应答的标准，基于请求/相应范式，通常使用TCP协议，从上世纪90年代至今先后经历了HTTP/1.0、HTTP/1.1、HTTP/2.0等多个版本的更替，大部分是向下兼容的。其中应用最广泛的是HTTP/1.0和HTTP/1.1。从HTTP/1.0开始，提供了GET/POST/HEAD等不同的请求方式，并且支持任何格式内容的发送；HTTP/1.0的缺点在于每个TCP连接只能发送一次请求，而建立TCP连接的成本较高，这就导致了HTTP/1.0的性能较低。在HTTP/1.1协议中对这个问题提供了标准的解决方案，即单个TCP连接可以被多个请求复用，并且引入了管道机制来进一步改进HTTP协议的通信效率。[18]

* MQTT

MQTT(Message Queuing Telemetry Transport，中文翻译为消息队列遥测传输)协议是基于发布/订阅范式的ISO标准消息协议，工作在TCP/IP协议之上，是为硬件性能低下的远程设备以及网络状况糟糕的情况下而设计的。

一个MQTT系统包括一台服务器，被称为消息中间件(Message Broker)，以及与这台服务器进行交互的多台客户端。每个客户端既可以作为一类消息的订阅者，也可以作为消息的发布者。所有消息都按照话题来分类组织，客户端要发送一条新的数据时，它会先把数据和话题声明发送给中间件，再由中间件将这条数据发布给所有订阅了该话题的所有订阅者。发布者无需事先了解有关订阅者的任何信息，订阅者亦此，发布者和订阅者只需关注自己感兴趣的消息话题以及消息本身即可。

* CoAP

CoAP(Constrained Application Protocol，中文翻译为受限制的应用协议)是一种专门为资源受限设备定义的应用层网络协议，基于经典的请求/相应范式，设计之初就是面向物联网中的受约束节点和受约束的网络，所以最大的特点就是轻量、低功耗。另外在移动通信网络的短消息服务(Short Message Service, SMS)中也有应用。CoAP既可以很方便地与HTTP协议相结合，同时也能满足一些特殊的应用需求，例如多播支持(multicast)。CoAP协议支持在UDP协议上工作。

* WebSocket

HTTP协议最大的缺陷在于，通信只能由客户端发起。而WebSocket协议的诞生就是为了解决这个问题。WebSocket是一种依赖于TCP/IP协议的全双工通信协议，允许服务端主动向客户端推送数据。客户端和服务端只需进行一次握手，就可以建立持久性的连接，并进行双向数据传输。WebSocket可以使用与HTTP相同的端口工作，也可以支持HTTP代理和中介[17]，从而兼容HTTP协议。

* HTTPS

HTTPS(HyperText Transfer Protocol Secure，中文翻译为超文本传输安全协议)是在HTTP协议之上的一种安全的传输协议。HTTPS经由HTTP进行通信，但利用SSL/TLS(Secure Sockets Layer，安全套接层；Transport Layer Security，传输层安全性协议)来加密数据包，从而实现在不安全的网络上创建一个安全通道，防止攻击者通过监听和中间人攻击等手段窃取通信内容。

HTTP协议和SSL/TLS安全协议都属于应用层，而安全协议工作在HTTP之下、传输层之上。在运行过程中，安全协议向运行HTTP的进程提供一个类似于TCP的套接字，让进程注入报文，安全协议将报文加密之后交给运输层；或是从运输层获取加密报文，解密后交给对应的HTTP进程。可以理解为在现有的HTTP协议和TCP/IP协议之间增加一个加工步骤。

实际上，MQTT和CoAP等协议也可以通过添加SSL/TLS层，成为安全的通信协议。WebSocket亦然。

服务器在支持HTTPS连接之前，需要创建一份数字证书，并交给证书颁发机构签名，只有签名的数字证书才能被连接者接受。

#### PKI

PKI(Public Key Infrastructure，中文翻译为公开密钥基础建设)是一组由硬件、软件、参与者、管理政策与流程组成的基础架构，用来实现非对称密钥对和数字证书的产生、管理、存储、分发和撤销等功能。一个典型的PKI系统包括PKI策略、数字证书认证机构(Certificate Authority，CA)、注册管理中心(Registration Authority，RA)、证书发布系统和PKI应用等。在安全通信协议中使用到的数字证书就是由PKI的CA来负责签发的。

PKI架构实际上也是一种中心化的架构。实际的网络环境中会存在多个CA，CA之间是根据严格层次信任模型来组织管理的，可以看成是倒转的树形结构，上层CA为下层CA颁发数字证书，最顶层的一个CA称为根CA。一个域内所有签发的数字证书都由这个域的CA负责，当某个CA签发的任何一份数字证书存在问题时，其他人有理由对这个CA签发的所有其他证书都予以否认。

### 区块链

#### 数据结构

作为比特币的一个基础概念，区块链(Blockchain)是使用密码学串接并保证数据内容不可篡改的串联数据结构，可以作为去中心化的数据库来使用，用来存储若干条交易数据。从结构上来看，区块链由多个区块串连而成，每个区块包含前一个区块的哈希值、相应时间戳、以及当前区块存储的数条交易数据。保证数据不可篡改的关键就在于将前一个区块的哈希值加入当前区块内容，这样当某个区块内容发生变化之后，哈希值必然随之改变，就不再符合下一个区块中存储的哈希值；哈希值作为区块内容的一部分，又能保证哈希值本身不能被篡改，从而实现数据保护。

#### 区块链网络

狭义的区块链指的就是区块链这种数据结构，而广义的区块链指的是利用区块链繁衍出来的区块链网络体系，这个体系使用区块链结构来验证与存储数据、使用分布式的共识机制来管理决策和更新数据、使用密码学的方式保证数据传输的安全、使用由自动化脚本生成的智能合约来编程和操作数据。

区块链网络具有以下特点：

* 去中心化：数据的存储和验证都是采用分布式的解决方案，不存在中心化的管理机构，所有节点的地位都是公平的。
* 开放自治：系统是开放的，区块链上的数据对所有人公开；系统的每个节点都遵循全网统一的协议，使得所有节点能够在去信任的环境下安全地交换数据，任何人为的干预都不能对其干扰。
* 信息不可篡改：区块链的数据结构特点保证了数据存储之后不可篡改，以采用POW作为共识机制的网络为例，除非能够同时控制住全网51%或以上的节点[19]，否则在少数节点上对区块链数据进行的修改对整个系统而言是无效的。
* 匿名性：节点身份不会暴露有关节点个体的任何信息，节点之间是通过使用特定的算法和密码学技术来相互信任的。

#### 共识机制

共识机制(Consensus Mechanism)是区块链系统安全性的重要保障，它指的是一种通过节点的投票或运算，能短时间在全网范围内对某笔交易的有效性达成共识的机制。共识机制的目的是让同一区块链网络内的所有诚实节点都拥有内容一致的区块链。常见的区块链共识机制有：工作量证明(Proof of Work, POW)，权益证明(Proof of Stake, PoS)，股份授权证明(Delegated Proof of Share, DPoS)，拜占庭容错(Byzantine Fault Tolerance, BFT)等。

在共识机制中也可以加入激励机制，来维持区块链网络的健康运行，例如比特币网络采用工作量证明的共识机制，矿工节点的“挖矿”其实就是工作量的体现，协议规定首个验证了新区块有效的节点可以获得一定的比特币奖励，这样的奖励机制既是比特币发行货币的机制，也是保持比特币体系持续发展的动力。

#### 智能合约

智能合约(Smart Contract)是一种特殊的计算机协议，旨在以数字化的方式来执行合约、传播和验证数据。智能合约允许节点在没有第三方的情况下进行可信交易，这些交易可以被追踪但不可被逆转。智能合约的目的是提供比传统合约更安全、更轻量的交易途径。

智能合约实际上是一套可以自动执行的计算机程序，而合约本身也是系统的一个参与者：它对接收到的信息进行回应，同时可以接收和储存数据，也可以向外发送信息和价值。也就是说，智能合约可以为系统的其他参与方提供执行交易和事件监听的接口，同时约束参与方的执行能力。当网络节点在区块链网络上部署了智能合约，就意味着所有的参与方都达成了协定，开始共同遵循这套智能合约的内容。

### 比特币：基于区块链实现的去中心化虚拟货币体系

区块链往往与比特币形影不离，虽然区块链相关的技术在比特币诞生之前就已经存在了，智能合约也是上世纪90年代就已经由法律学者尼克·萨博提出，几乎与互联网同龄，但在比特币之前一直没有得到有效的应用。直到比特币才是对区块链技术的第一次大规模成功应用。所以有必要再介绍一下比特币的相关要点，同时也是作为区块链技术应用的拓展。

比特币网络就是一个区块链网络。而作为一种虚拟货币，比特币在基于区块链网络的实现之上，还多了一些关键概念。

#### 交易

比特币交易是比特币系统中最关键的部分。实际上，根据比特币系统的设计原理，系统的所有实现都是为了确保比特币交易可以被生成、能在比特币网络中得以传播和通过验证，并最终添加入比特币区块链。比特币交易的本质是数据结构，这些数据结构中包含交易双方身份、交易金额等信息。

区块链存储的“交易”与比特币的交易含义略有不同，区块链中存储的“交易”可以理解为数据的划分单位，一笔交易代表一条数据，这条数据可以就是一条比特币交易信息。

比特币交易的确认会经过以下步骤：比特币交易数据在打包到一个区块中后，交易就被初步确认了；当区块链接到前一个区块之后，意味着交易得到了进一步确认；在连续得到六个区块的确认之后，这笔交易就不可逆转地得到确认了。

#### 账户

一笔交易包含支付方和接受方，意味着涉及到两个账户。在比特币系统中申请账户的时候，会为每个账户分配一个独一无二的比特币地址，并生成一份非对称公私钥，私钥需要妥善保管，因为只有私钥是拥有该账户的唯一凭证，证明使用者对该比特币地址上的比特币拥有所有权。

#### 钱包

比特币钱包并不包含比特币，实际上钱包中只包含私钥。比特币钱包是一个应用程序，为用户提供交互界面，功能包括管理密钥和比特币地址、跟踪余额、创建和签名交易等。

